apiVersion: v1
kind: ConfigMap
metadata:
  name: cm-php-fpm
data:
  www.conf: |
    [www]
    user = www-data
    group = www-data
    listen = /run/php/php8.1-fpm.sock
    listen.owner = www-data
    listen.group = www-data

    ; ===============================================================
    ; === PHP-FPM PROCESS MANAGEMENT (Optimized for 16GB Node) ===
    ; ===============================================================
    pm = dynamic
    pm.max_children = 45           ; max 60 concurrent PHP workers
    pm.start_servers = 8
    pm.min_spare_servers = 6
    pm.max_spare_servers = 12
    pm.max_requests = 600          ; recycle workers to prevent memory leaks
    pm.process_idle_timeout = 10s  ; free idle workers faster
    request_terminate_timeout = 180s ; max allowed time for any PHP request

    ; ===============================================================
    ; === PHP CORE SETTINGS (Optimized for Performance & Stability)
    ; ===============================================================
    php_admin_value[memory_limit] = 256M
    php_admin_value[upload_max_filesize] = 5M
    php_admin_value[post_max_size] = 150M
    php_admin_value[max_file_uploads] = 20
    php_admin_value[max_execution_time] = 180
    php_admin_value[max_input_time] = 180
    php_admin_value[realpath_cache_size] = 4096k
    php_admin_value[realpath_cache_ttl] = 600

    ; ===============================================================
    ; === PHP OPCACHE SETTINGS (Reduce CPU load & Speed Up PHP)
    ; ===============================================================
    ; Opcache stores compiled PHP code in memory, reducing processing time
    php_admin_value[opcache.enable] = 1
    php_admin_value[opcache.enable_cli] = 0
    php_admin_value[opcache.memory_consumption] = 256        ; shared memory for cache
    php_admin_value[opcache.interned_strings_buffer] = 16     ; memory for interned strings
    php_admin_value[opcache.max_accelerated_files] = 20000    ; max cached scripts
    php_admin_value[opcache.revalidate_freq] = 2              ; recheck scripts every 2s
    php_admin_value[opcache.validate_timestamps] = 1          ; keep in sync with file changes
    php_admin_value[opcache.fast_shutdown] = 1                ; faster PHP shutdown
    php_admin_value[opcache.max_wasted_percentage] = 5        ; restart when fragmentation >5%

    ; ===============================================================
    ; === LOGGING & MONITORING
    ; ===============================================================
    php_admin_flag[log_errors] = on
    php_admin_value[error_log] = /proc/self/fd/2
    pm.status_path = /status
    slowlog = /proc/self/fd/2
    request_slowlog_timeout = 15s
