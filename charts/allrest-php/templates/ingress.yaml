apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: allrest-ingress
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/issuer: letsencrypt-nginx-issuer

    # === Upload limits & timeouts ===
    nginx.ingress.kubernetes.io/proxy-body-size: "220m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "40"

    # === Global rate limits (frontend users) ===
    nginx.ingress.kubernetes.io/limit-rps: "80"
    nginx.ingress.kubernetes.io/limit-burst: "100"
    nginx.ingress.kubernetes.io/limit-connections: "200"

    # === Compression ===
    nginx.ingress.kubernetes.io/enable-gzip: "true"
    nginx.ingress.kubernetes.io/enable-brotli: "true"
    nginx.ingress.kubernetes.io/gzip-types: "text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript"

    # === HTTPS ===
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"

    # === API-specific stricter limits ===
    nginx.ingress.kubernetes.io/server-snippet: |
      if ($host = "api.allrestaurants.eu") {
        limit_req zone=api_zone burst=20 nodelay;
      }
      if ($host = "allsupplier-api.allrestaurants.eu") {
        limit_req zone=api_zone burst=15 nodelay;
      }
      if ($host = "alltm-api.allrestaurants.eu") {
        limit_req zone=api_zone burst=10 nodelay;
      }

spec:
  tls:
    - hosts:
        - allrestaurants.eu
        - "*.allrestaurants.eu"
        - allrestaurants.info
      secretName: letsencrypt-nginx-eu-new

  rules:
    # Website frontend
    - host: allrestaurants.eu
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: allrest-php-service
                port:
                  number: 80
    - host: "*.allrestaurants.eu"
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: allrest-php-service
                port:
                  number: 80
    - host: allrestaurants.info
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: allrest-php-service
                port:
                  number: 80

    # Admin panel
    - host: adminpanel.allrestaurants.eu
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: alltm-admin-panel-service
                port:
                  number: 80

    # APIs
    - host: api.allrestaurants.eu
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: allrest-api-service
                port:
                  number: 80

    - host: allsupplier-api.allrestaurants.eu
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: allsupplier-api-service
                port:
                  number: 80

    - host: alltm-api.allrestaurants.eu
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: alltm-api-service
                port:
                  number: 80
